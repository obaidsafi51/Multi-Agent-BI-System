# Ultra-fast uv-based build for development (no venv needed in Docker)
FROM python:3.11-slim

WORKDIR /app

# Install uv (much faster than pip)
RUN pip install --no-cache-dir uv

# Create user
RUN useradd -m tidbmcp

# Copy minimal requirements for faster dependency caching
COPY --chown=tidbmcp:tidbmcp pyproject.toml ./

# Install directly to system Python (no venv needed in containers)
RUN uv pip install --system \
    fastapi==0.104.1 \
    uvicorn==0.24.0 \
    pydantic==2.5.0 \
    aiohttp==3.9.0

# Copy source code after dependencies (better layer caching)
COPY --chown=tidbmcp:tidbmcp src/ ./src/

# Set ownership
RUN chown -R tidbmcp:tidbmcp /app

USER tidbmcp

ENV PYTHONPATH="/app/src"

EXPOSE 8000

CMD ["uvicorn", "--host", "0.0.0.0", "--port", "8000", "tidb_mcp_server.http_api:app"]
